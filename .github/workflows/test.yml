name: æ›´æ–°é€šçŸ¥

on:
  schedule:
    - cron: '0 4 * * *'  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æŸ¥æ›´æ–°
        env:
          QMSG_KEY: ${{ secrets.QMSG_KEY }}
          QMSG_QQ: ${{ secrets.QMSG_QQ }}
          TARGET_REPO: ${{ secrets.TARGET_REPO }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ============= é…ç½®å’ŒéªŒè¯ =============
          echo "===== å¼€å§‹æ£€æŸ¥ä»“åº“: ${TARGET_REPO} ====="
          
          if [ -z "$TARGET_REPO" ]; then
            echo "âŒ é”™è¯¯: TARGET_REPOæœªè®¾ç½®"
            exit 1
          fi
          
          if [ ! -f last_commit.txt ]; then
            echo "âŒ é”™è¯¯: last_commit.txtæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          last_commit=$(cat last_commit.txt | tr -d ' \n')
          if [ -z "$last_commit" ]; then
            echo "âŒ é”™è¯¯: last_commit.txtå†…å®¹ä¸ºç©º"
            exit 1
          fi
          
          if [[ ! "$last_commit" =~ ^[a-f0-9]{40}$ ]]; then
            echo "âŒ é”™è¯¯: last_commit.txtå†…å®¹ä¸æ˜¯æœ‰æ•ˆçš„commit SHA"
            exit 1
          fi
          
          echo "ä¸Šæ¬¡è®°å½•: ${last_commit:0:7}"
          

          echo "æ­¥éª¤1: æ£€æŸ¥æ–°æäº¤..."
          
          all_commits=()
          page=1
          
          while :; do
            retry=3
            while [ $retry -gt 0 ]; do
              response=$(curl -s -w "\n%{http_code}" \
                --max-time 30 \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${TARGET_REPO}/commits?per_page=100&page=$page")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              if [ "$http_code" = "200" ] && echo "$body" | jq -e '.[0].sha' >/dev/null 2>&1; then
                break
              fi
              
              retry=$((retry - 1))
              [ $retry -gt 0 ] && sleep 3
            done
            
            if [ $retry -eq 0 ]; then
              echo "âŒ è·å–æäº¤å¤±è´¥ï¼ˆHTTP $http_codeï¼‰"
              exit 1
            fi
            
            commit_shas=$(echo "$body" | jq -r '.[].sha')
            if [ -z "$commit_shas" ]; then
              break
            fi
            
            found_old=false
            for sha in $commit_shas; do
              if [ "$sha" = "$last_commit" ]; then
                found_old=true
                break
              fi
              all_commits+=("$sha")
            done
            
            [ "$found_old" = true ] && break
            page=$((page + 1))
            
            if [ $page -gt 10 ]; then
              echo "âš ï¸ è¾¾åˆ°æœ€å¤§æŸ¥è¯¢æ·±åº¦"
              break
            fi
          done
          
          new_count=${#all_commits[@]}
          if [ $new_count -eq 0 ]; then
            echo "âœ“ æš‚æ— æ›´æ–°"
            exit 0
          fi
          
          echo "å‘ç° $new_count ä¸ªæ–°æäº¤"
          
          
          all_msgs="ğŸ“¢ ä»“åº“æ›´æ–°é€šçŸ¥%0A"
          msg_count=0
          
          for ((i=new_count-1; i>=0; i--)); do
            commit_sha="${all_commits[i]}"
            msg_count=$((msg_count + 1))
            
            retry=3
            while [ $retry -gt 0 ]; do
              commit_detail=$(curl -s --max-time 20 \
                -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${TARGET_REPO}/commits/${commit_sha}")
              
              if echo "$commit_detail" | jq -e '.sha' >/dev/null 2>&1; then
                break
              fi
              
              retry=$((retry - 1))
              [ $retry -gt 0 ] && sleep 2
            done
            
            commit_time=$(echo "$commit_detail" | jq -r '.commit.author.date' | sed 's/T/ /' | cut -d'+' -f1)
            bj_time=$(date -d "$commit_time" +'%Y-%m-%d %H:%M' 2>/dev/null || echo "$commit_time")
            
            all_files=$(echo "$commit_detail" | jq -r '.files // [] | .[].filename' 2>/dev/null)
            file_count=$(echo "$all_files" | grep -c '^' || echo 0)
            
            if [ "$file_count" -eq 0 ]; then
              file_list="â€¢ ï¼ˆæ— æ–‡ä»¶å˜æ›´ï¼‰"
            else
              display_files=$(echo "$all_files" | head -5)
              file_list=$(echo "$display_files" | sed 's/^/â€¢ /')
              if [ "$file_count" -gt 5 ]; then
                remaining=$((file_count - 5))
                file_list="${file_list}%0A...ï¼ˆè¿˜æœ‰${remaining}ä¸ªï¼‰"
              fi
            fi
            
            msg_block="%0A%0Aã€æ›´æ–° #${msg_count}ã€‘%0Aâ° æ—¶é—´ï¼š${bj_time}%0AğŸ”– Commitï¼š${commit_sha:0:7}%0AğŸ“ æ–‡ä»¶ï¼š${file_count}ä¸ª%0A${file_list}"
            all_msgs="${all_msgs}${msg_block}"
            
            echo "å·²æ·»åŠ : ${commit_sha:0:7}"
          done
          
          all_msgs="${all_msgs}%0A%0Aâœ… å…± ${msg_count} æ¬¡æ›´æ–°"
          
          
          echo "æ­¥éª¤2: å†…å®¹å®‰å…¨æ£€æµ‹..."
          
          SEPARATOR="ğŸ˜‚"
          
          echo "ä½¿ç”¨åˆ†éš”ç¬¦: $SEPARATOR"
          
          
          safe_msg=$(echo "$all_msgs" | sed "s/2b/2${SEPARATOR}b/g; s/2B/2${SEPARATOR}B/g")
          
          safe_msg=$(echo "$safe_msg" | sed "s/sb/s${SEPARATOR}b/g; s/SB/S${SEPARATOR}B/g")
          
          safe_msg=$(echo "$safe_msg" | sed 's/\([0-9]\)b/\1'${SEPARATOR}'b/g')
          
          echo "åŸæ¶ˆæ¯é•¿åº¦: ${#all_msgs} -> ${#safe_msg}"
          
          
          echo "æ­¥éª¤3: å‘é€é€šçŸ¥åˆ°QQ..."
          send_result=$(curl -s --max-time 30 -X POST "https://qmsg.zendee.cn/send/${QMSG_KEY}" \
            -d "msg=${safe_msg}" \
            -d "qq=${QMSG_QQ}")
          
          if echo "$send_result" | grep -q '"success":true'; then
            echo "âœ… é€šçŸ¥å‘é€æˆåŠŸ"
          else
            echo "âŒ é€šçŸ¥å‘é€å¤±è´¥: $send_result"
            exit 1
          fi
          
          
          latest_commit="${all_commits[0]}"
          echo "$latest_commit" > last_commit.txt
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          git add last_commit.txt
          if git diff --staged --quiet; then
            echo "âš ï¸ è®°å½•æœªå˜åŒ–"
          else
            git commit -m "æ›´æ–°è®°å½•: ${latest_commit:0:7}"
            git push && echo "âœ… è®°å½•å·²ä¿å­˜" || echo "âŒ æ¨é€å¤±è´¥"
          fi
          
          echo "===== æ£€æŸ¥å®Œæˆ ====="
